<?xml version="1.0" encoding="utf-8"?>
<Project>
    <PropertyGroup>
        <_SourceLinkSpaceAssemblyFile Condition="'$(MSBuildRuntimeType)' != 'Core'">$(MSBuildThisFileDirectory)..\tools\net461\SpaceDotNet.SourceLink.dll</_SourceLinkSpaceAssemblyFile>
        <_SourceLinkSpaceAssemblyFile Condition="'$(MSBuildRuntimeType)' == 'Core'">$(MSBuildThisFileDirectory)..\tools\netcoreapp2.0\SpaceDotNet.SourceLink.dll</_SourceLinkSpaceAssemblyFile>
    </PropertyGroup>

    <PropertyGroup>
        <EnableSourceLink Condition="'$(EnableSourceLink)' == ''">true</EnableSourceLink>
    </PropertyGroup>

    <UsingTask TaskName="SpaceDotNet.SourceLink.GetSourceLinkUrl" AssemblyFile="$(_SourceLinkSpaceAssemblyFile)"/>
    <UsingTask TaskName="SpaceDotNet.SourceLink.TranslateRepositoryUrls" AssemblyFile="$(_SourceLinkSpaceAssemblyFile)"/>

    <PropertyGroup>
        <SourceLinkUrlInitializerTargets>$(SourceLinkUrlInitializerTargets);_InitializeSpaceSourceLinkUrl</SourceLinkUrlInitializerTargets>
        <SourceControlManagerUrlTranslationTargets>$(SourceControlManagerUrlTranslationTargets);TranslateSpaceUrlsInSourceControlInformation</SourceControlManagerUrlTranslationTargets>
    </PropertyGroup>

    <Target Name="_InitializeSpaceSourceLinkUrl" Inputs="@(SourceRoot)" Outputs="|%(Identity)|">
        <!--
          The task calculates SourceLink URL for a given SourceRoot.
    
          If the SourceRoot is associated with a git repository with a recognized domain the <see cref="SourceLinkUrl"/>
          output property is set to the content URL corresponding to the domain, otherwise it is set to string "N/A".
    
          Recognized domains are specified via Hosts (initialized from SourceLinkSpaceHost item group).
          In addition, if SourceLinkHasSingleProvider is true an implicit host is parsed from RepositoryUrl.
    
          Example of SourceLinkSpaceHost items:
    
          <ItemGroup>
            <SourceLinkSpaceHost Include="my.jetbrains.space" ContentUrl="https://my.jetbrains.space"/>
            <SourceLinkSpaceHost Include="my.jetbrains.space" />     ContentUrl defaults to https://my.jetbrains.space
            <SourceLinkSpaceHost Include="demo.jetbrains.space" />   ContentUrl defaults to https://demo.jetbrains.space
          </ItemGroup>
    
          ContentUrl is optional. If not specified it defaults to "https://{domain}" or "http://{domain}", based on the scheme of SourceRoot.RepositoryUrl.
        -->
        <SpaceDotNet.SourceLink.GetSourceLinkUrl RepositoryUrl="$(PrivateRepositoryUrl)" SourceRoot="@(SourceRoot)" Hosts="@(SourceLinkSpaceHost)" IsSingleProvider="$(SourceLinkHasSingleProvider)">
            <Output TaskParameter="SourceLinkUrl" PropertyName="_SourceLinkUrlToUpdate"/>
        </SpaceDotNet.SourceLink.GetSourceLinkUrl>

        <ItemGroup>
            <!-- Only update the SourceLinkUrl metadata if the SourceRoot belongs to this source control -->
            <SourceRoot Update="%(Identity)" SourceLinkUrl="$(_SourceLinkUrlToUpdate)" Condition="'$(_SourceLinkUrlToUpdate)' != 'N/A'"/>
        </ItemGroup>
    </Target>

    <!-- 
      We need to translate ssh URLs to https.
    -->
    <Target Name="TranslateSpaceUrlsInSourceControlInformation">
        <ItemGroup>
            <_TranslatedSourceRoot Remove="@(_TranslatedSourceRoot)"/>
        </ItemGroup>

        <SpaceDotNet.SourceLink.TranslateRepositoryUrls RepositoryUrl="$(ScmRepositoryUrl)" SourceRoots="@(SourceRoot)" Hosts="@(SourceLinkSpaceHost)" IsSingleProvider="$(SourceLinkHasSingleProvider)">
            <Output TaskParameter="TranslatedRepositoryUrl" PropertyName="ScmRepositoryUrl"/>
            <Output TaskParameter="TranslatedSourceRoots" ItemName="_TranslatedSourceRoot"/>
        </SpaceDotNet.SourceLink.TranslateRepositoryUrls>

        <ItemGroup>
            <SourceRoot Remove="@(SourceRoot)"/>
            <SourceRoot Include="@(_TranslatedSourceRoot)"/>
        </ItemGroup>
    </Target>

</Project>